<html><head><title>API for Dynamic Component Changes</title><style type="text/css">ol{margin:0;padding:0}.c7{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c4{text-indent:36pt;margin-left:36pt}.c0{direction:ltr}.c2{font-weight:bold}.c5{text-indent:36pt}.c6{font-family:"Courier New"}.c1{font-style:italic}.c3{height:11pt}.title{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:36pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}.subtitle{padding-top:18pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:24pt;font-family:"Georgia";padding-bottom:4pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:18pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}h2{padding-top:18pt;line-height:1.15;text-align:left;color:#000000;font-size:14pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h3{padding-top:14pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h4{padding-top:12pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Arial";padding-bottom:2pt}h5{padding-top:11pt;line-height:1.15;text-align:left;color:#666666;font-size:10pt;font-family:"Arial";font-weight:bold;padding-bottom:2pt}h6{padding-top:10pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:10pt;font-family:"Arial";padding-bottom:2pt}</style></head><body class="c7"><p class="c0"><span class="c2">Dynamic Component Tree Changes</span></p><p class="c0 c3"><span class="c2"></span></p><p class="c0"><span class="c2">Problems to address</span></p><p class="c0"><span>- Currently there is no indication on a component as to whether it is part of the DOM hierarchy or not (should we expose this as a public property?)</span></p><p class="c0"><span>- The framework needs to support removing a component from one parent and adding that component to a different parent, preferably within one draw cycle (if the component is already loaded)</span></p><p class="c0"><span>- Currently there is no clean up phase for components, components have no designated place to remove event listeners and other cleanup tasks which can influence garbage collection</span></p><p class="c0"><span>- There is an issue where components are still trying to draw even though they have been removed (we think), it manifests as a console error &ldquo;Warning: Trying to replace element &quot;, element,&quot; which has no parentNode&quot;</span></p><p class="c0 c3"><span></span></p><p class="c0"><span class="c2">Initial Thoughts</span></p><p class="c0"><span>- prepareForDraw (or something like it) should be called the first time a component is participating in the draw cycle, and every time after it has been added to the component hierarchy, not just once(?)</span></p><p class="c0"><span>- There needs to be a symmetrical counterpart to prepareForDraw, which is called every time a component is removed from the component hierarchy</span></p><p class="c0"><span>- These lifecycle methods could be keyed off of entering and exiting a component hierarchy</span></p><p class="c0"><span>- Reparenting content through bindings needs to be handled</span></p><p class="c0"><span>- Do we want to encourage developers to never use appendChild or removeChild? [At least for elements that have controllers attached]</span></p><p class="c0"><span>- What are the ways that a component can be added or removed from the hierarchy?</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- The &lsquo;domContent&rsquo; property of a component is reset</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- attachToParentComponent (this does not handle DOM changes)</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- detachFromParentComponent (this does not handle DOM changes)</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- setElementWithParent (should still need to call attachToParentComponent? [But if the element has not changed parents yet then attachToParentComponent will cause the wrong structure to be created])</span></p><p class="c0"><span>- Need to distinguish between when an element is added to just its parent documentFragment, vs. the parent is inserted into the DOM, or when a component is attached to a parent, but the parent has not put the child&rsquo;s element in the DOM yet (could happen with any slot based component or a repetition)</span></p><p class="c0"><span>- What do we do on &ldquo;firstDraw&rdquo; that makes it special? &nbsp;How is it different from any initial draw after entering the document? &nbsp;It&rsquo;s really related to has the template been replaced or not?</span></p><p class="c0"><span>- When a template based component is re-inserted into the DOM should replaceElementWithTemplate be called again? &nbsp;(Probably not, any changes should be preserved in the case of a condition component)</span></p><p class="c0"><span>- Currently general DOM manipulation at the framework level is triggered either as a result of initial application load/deserialization or by changing the domContent property on a component</span></p><p class="c0"><span>- Should the firstDraw event be fired after the first draw that occurs when a component that has been removed from the document is added back into it? &nbsp;firstDrawUponEnteringDocument?</span></p><p class="c0"><span>- Composer loading/unloading could be tied to new API elementWasAddedToDOM and elementWillBeRemovedFromDOM (still doesn&rsquo;t resolve issue of adding composers to components that don&rsquo;t need to be drawn, i.e. key-composers)</span></p><p class="c0"><span>- Should there be a &ldquo;reset&rdquo; method which is called after the element is removed from the document?</span></p><p class="c0"><span>- What needs to be cleaned up or added when dealing with components?</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- bindings</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- needsDraw (added or removed from drawList) (be sure to consider components that are in the middle of loading)</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- event listeners</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- CSS animations</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- assets (CSS files, scripts, etc.)</span></p><p class="c0"><span>- Don&rsquo;t forget the case of components that do not have templates</span></p><p class="c0"><span>- Differences between component that is removing vs. component that is being removed</span></p><p class="c0"><span>- Deletion of a component vs. temporary removal from the tree (either tree)</span></p><p class="c0 c3"><span></span></p><p class="c0"><span>Possible sequence</span></p><p class="c0"><span>enterComponentTree -&gt; prepareForDraw -&gt; enterDocument -&gt; draw -&gt; exitComponentTree -&gt; exitDocument -&gt; -&gt; enterComponentTree ( || dispose) -&gt; enterDocument -&gt; draw -&gt; exitComponentTree -&gt; exitDocument -&gt; (rinse/repeat)</span></p><p class="c0 c3"><span></span></p><p class="c0"><span>- An API that uses ranges?</span></p><p class="c0"><span>- Each component keeps a list of its child components that should be removed or added during the DOM (elements with controllers) manipulation phase of the draw?</span></p><p class="c0"><span>- Component implements an API similar to range, the methods would keep track of what changes need to be made, but delay making them until the draw cycle?</span></p><p class="c0"><span>- Change </span><span class="c1">originalContent</span><span>&nbsp;and </span><span class="c1">domContent</span><span>? &nbsp;</span><span class="c6">insertContent(content, range)</span><span>&nbsp;and/or </span><span class="c6">insertContent.async(content, range, function(){})</span></p><p class="c0 c3"><span></span></p><p class="c0"><span class="c2">Implementation Problems</span></p><p class="c0"><span>- Currently it cannot be distinguished whether an element is being added to a documentFragment vs. the rootDocument</span></p><p class="c0"><span>- Components can be part of the component hierarchy without having their elements attached to the DOM, so traversing the component hierarchy is not correct, (or it should be changed so that a component cannot be part of the hierarchy if its element is not, but there will also be some delay since the element is added into the DOM after the component hierarchy has been updated)</span></p><p class="c0"><span>- When is the component hierarchy built?</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Through attachToParentComponent which uses the DOM structure to figure out which component the parent is</span></p><p class="c0"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Through _addChildComponent when setting domContent</span></p><p class="c0"><span>- In one scenario the dom hierarchy is being built up first and the component hierarchy is then based on this, in the other scenario the component hierarchy is being built first and then the dom is being updated to match</span></p><p class="c0 c3"><span></span></p><p class="c0 c3"><span></span></p><p class="c0"><span class="c2">Existing Public API for Managing Component Lifecycle</span></p><p class="c0 c5"><span class="c1">setElementWithParentComponent(element, parent)</span></p><p class="c0 c5"><span class="c1">attachToParentComponent()</span></p><p class="c0 c5"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_addChildComponent(childComponent)</span></p><p class="c0 c5"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Adds the child into the component hierarchy but no DOM manipulation, flags the childComponent for DOM manipulation in the next draw cycle?</span></p><p class="c0 c5"><span class="c1">detachFromParentComponent()</span></p><p class="c0 c4"><span class="c1">removeChildComponent(childComponent) -- make this private</span></p><p class="c4 c0"><span>Removes the childComponent from the component hierarchy but no DOM manipulation, flags the childComponent for DOM manipulation in the next draw cycle?</span></p><p class="c0 c3"><span></span></p><p class="c0 c5"><span class="c1">canDraw()</span></p><p class="c0 c5"><span class="c1">prepareForDraw()</span></p><p class="c0 c5"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>- Current contract says that the component&rsquo;s element will be inserted into a DOM structure before prepareForDraw is called (it could be just the parent&rsquo;s structure)</span></p><p class="c0 c5"><span class="c1">willDraw(timestamp)</span></p><p class="c0 c5"><span class="c1">draw(timestamp)</span></p><p class="c0 c5"><span class="c1">didDraw(timestamp)</span></p><p class="c0 c5"><span class="c1">childComponentWillPrepareForDraw(child) - Can we remove this API if we add methods for DOM insertion and removal? &nbsp;Currently it&rsquo;s used by the loader component in order to know that Main is ready to draw</span></p><p class="c0 c3"><span></span></p></body></html>